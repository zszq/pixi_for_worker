<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>pixi.js for worker</title>
  
  <style>
    html, body {
      margin: 0;
      padding: 0;
    }
    canvas {
      border: 1px solid black;
    }
  </style>
</head>
<body>
  <canvas width="800" height="600"></canvas>

  <script>
    function cloneEvent(e) {
      const exclude = [
        "path",
        "view",
        "target",
        "srcElement",
        "currentTarget",
        "sourceCapabilities",
        "toElement",
        "fromElement",
        "relatedTarget"
      ];
      if (e === undefined || e === null) return undefined;
      const clone = {};
      for (const p in e) {
        if (exclude.find((el) => el === p)) {
          continue;
        }
        if (typeof e[p] === "function") {
          continue;
        }
        clone[p] = e[p];
      }
  
      return clone;
    }
  
    var pixiWorker = new Worker("worker.js");
  
    const eventListeners = {
      mousemove: (e) => {
        pixiWorker.postMessage({
          type: "event",
          event: { type: "mousemove", data: cloneEvent(e) },
          messageType: "notify",
          eventId: -1,
        });
      },
      mousedown: (e) => {
        pixiWorker.postMessage({
          type: "event",
          event: { type: "mousedown", data: cloneEvent(e) },
          messageType: "notify",
          eventId: -1,
        });
      },
      mouseup: (e) => {
        pixiWorker.postMessage({
          type: "event",
          event: { type: "mouseup", data: cloneEvent(e) },
          messageType: "notify",
          eventId: -1,
        });
      },
      mouseover: (e) => {
        pixiWorker.postMessage({
          type: "event",
          event: { type: "mouseover", data: cloneEvent(e) },
          messageType: "notify",
          eventId: -1,
        });
      },
      mouseout: (e) => {
        pixiWorker.postMessage({
          type: "event",
          event: { type: "mouseout", data: cloneEvent(e) },
          messageType: "notify",
          eventId: -1,
        });
      },
      // 只允许了按键tab事件，暂不处理
      // 用于辅助功能管理器重新创建了选项卡和屏幕阅读器阅读内容的能力,可以帮助残障人士访问 PixiJS 内容.
      // keydown: (e) => {
      //   pixiWorker.postMessage({
      //     type: "event",
      //     event: { type: "keydown", data: cloneEvent(e) },
      //     messageType: "notify",
      //     eventId: -1,
      //   });
      // },
    };
  
    const canvas = document.querySelector("canvas");
    const offscreen = canvas.transferControlToOffscreen();
    
    // document.body.addEventListener("keydown", eventListeners.keydown, false);
    document.body.addEventListener("mousemove", eventListeners.mousemove, true);
    document.body.addEventListener("mouseup", eventListeners.mouseup, true);
    canvas.addEventListener("mousedown", eventListeners.mousedown, true);
    canvas.addEventListener("mouseover", eventListeners.mouseover, true);
    canvas.addEventListener("mouseout", eventListeners.mouseout, true);

    // let clientRect = canvas.getBoundingClientRect(); // 按键tab事件
  
    pixiWorker.postMessage({
      type: "start",
      hostname: window.location.hostname,
      width: 500,
      height: 500,
      // clientRect, // 按键tab事件
      canvas: offscreen,
    }, [offscreen]);

  </script>
</body>
</html>